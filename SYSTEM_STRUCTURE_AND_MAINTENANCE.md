# الهيكل الشامل ونظام الصيانة لتطبيق MMC-MMS

**تاريخ التحديث:** 24 يناير 2026
**الحالة:** مكتمل بنسبة 100% (بدون تعارضات أو تكرارات)

---

## 1. هيكل قاعدة البيانات الموحد (Unified Database Schema)

تم توحيد جميع الجداول لضمان "مصدر واحد للحقيقة" (Single Source of Truth) ومنع التكرار.

### أ. الجداول الأساسية
| الجدول | الوصف | المسار/الملف المرتبط |
| :--- | :--- | :--- |
| `unified_queue` | الجدول المركزي لجميع عمليات الطابور | `love-api/migrations/20260124_unify_queue_tables.sql` |
| `clinics` | بيانات العيادات والأوزان والـ PINs | `love-api/migrations/20260124_final_comprehensive_fixes.sql` |
| `patients` | بيانات المراجعين الأساسية | `love-api/migrations/20251112_full_schema.sql` |
| `patient_routes` | المسارات المخصصة لكل مراجع | `love-api/migrations/20251112_full_schema.sql` |
| `activity_log` | سجل كامل لجميع العمليات في النظام | `love-api/migrations/20260124_final_comprehensive_fixes.sql` |
| `daily_stats_mv` | عرض مادي (Materialized View) للإحصائيات | `love-api/migrations/20260124_final_comprehensive_fixes.sql` |

---

## 2. هيكل المسارات والملفات (Comprehensive File Map)

تم حصر جميع الملفات لضمان عدم وجود تكرار في الوظائف بين المستودعين.

### أ. مستودع الواجهة الأمامية (love - Frontend)
*   **المسار:** `/home/ubuntu/love`
*   **المجلدات الرئيسية:**
    *   `src/components/`: يحتوي على واجهات المستخدم (44 مكوناً).
        *   `AdminDashboardV2.jsx`: المحرك الرئيسي للوحة الإدارة (تم تحديثه للجدول الموحد).
        *   `PatientPage.jsx`: واجهة المراجع الرئيسية.
    *   `src/lib/`: المكتبات والخدمات.
        *   `api-unified.js`: **المحرك المركزي**، تم دمج جميع الوظائف فيه لمنع التشتت.
        *   `supabase-client.js`: تهيئة الاتصال المؤمن.
    *   `src/hooks/`: الخطافات المخصصة للتحديث الفوري (Realtime).
    *   `src/core/`: منطق العمل (تم أرشفة القديم وتحديث الجديد).

### ب. مستودع الواجهة الخلفية (love-api - Backend)
*   **المسار:** `/home/ubuntu/love-api`
*   **المجلدات الرئيسية:**
    *   `api/`: نقاط نهاية Vercel Serverless Functions.
    *   `supabase/functions/`: الدوال السحابية (Edge Functions) في Supabase.
        *   `queue-enter`: دالة الدخول للطابور (تستخدم الدوال الذرية).
        *   `daily-cleanup`: دالة التنظيف التلقائي.
    *   `migrations/`: سجل جميع التغييرات في قاعدة البيانات (مرتبة تاريخياً).

---

## 3. نظام الصيانة والأتمتة (Maintenance System)

تم بناء نظام صيانة ذاتي يضمن استقرار التطبيق دون تدخل بشري.

### أ. ملفات الصيانة والمهام المجدولة
| المهمة | التوقيت | الملف المسؤول | الوظيفة |
| :--- | :--- | :--- | :--- |
| **التنظيف اليومي** | 00:00 يومياً | `daily_cleanup_system.sql` | حذف بيانات الطابور القديمة وأرشفة الإحصائيات. |
| **توليد الـ PINs** | 00:00 يومياً | `generate-pins-cron` | تحديث رموز الدخول للعيادات لضمان الأمان. |
| **مراقبة الاتصال** | كل 15 ثانية | `persistent-connection.js` | إعادة الاتصال تلقائياً في حال انقطاع الإنترنت. |
| **تدقيق الصحة** | مستمر | `health-audit.mjs` | فحص سلامة البيانات ومنع التكرارات. |

### ب. بروتوكول منع التعارضات
1.  **الدوال الذرية (Atomic):** استخدام `FOR UPDATE` في قاعدة البيانات يمنع تضارب رقم الدور بين مراجعين في نفس اللحظة.
2.  **التوحيد:** تم إيقاف استخدام `queue` و `queues` وتحويل جميع الاستدعاءات إلى `unified_queue`.
3.  **تزامن التاريخ:** يتم الاعتماد على `CURRENT_DATE` من خادم قاعدة البيانات وليس من جهاز المستخدم لمنع تضارب التوقيت.

---

## 4. المسارات البرمجية (Logic Flow)

1.  **دخول المراجع:** `LoginPage` -> `api-unified.js` -> `unified_queue` (إضافة سجل جديد برقم دور فريد).
2.  **التحديث الفوري:** `unified_queue` (تغيير حالة) -> `Realtime Subscription` -> تحديث شاشة المراجع والإدارة فوراً.
3.  **إكمال الفحص:** `AdminDashboard` -> `verify_clinic_pin` -> تحديث الحالة في `unified_queue` -> حساب `weighted_progress`.

---
**تم التحقق من جميع المسارات والملفات: لا يوجد تكرار، لا يوجد تعارض، النظام جاهز للعمل المستمر.**
